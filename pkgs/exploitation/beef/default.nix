# Model after https://github.com/makefu/nur-packages/blob/master/beef/default.nix
{ stdenv, bundlerEnv, lib, fetchFromGitHub, makeWrapper, ruby, nodejs, writeText, fetchzip, includeGeoIPDatabase ? true,  ... }:
let
  beefGems = bundlerEnv {
    name = "beef-env";
    inherit ruby;
    gemdir = ./.;

    buildInputs = [ makeWrapper ];
  };

  geoIPDatabase = fetchzip {
    url = "https://web.archive.org/web/20191227182209/https://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz";
    sha256 = "u6Ie6HiWDVt3Xtkj7NI3eVB4I3bvPtWdB+1l5kBXm7M=";
  };

  beefScript = ''
    #!${stdenv.shell}
    PATH=$PATH:${nodejs}/bin/
    mkdir -p \$HOME/.beef/beef
    if [[ ! -f \$HOME/.beef/config.yaml ]]; then
      mkdir \$HOME/.beef
      cp $out/share/beef/config.yaml \$HOME/.beef/config.yaml
    fi 
    cp -r $out/share/beef/* \$HOME/.beef/beef
    chmod -R +rw \$HOME/.beef/beef
    cd \$HOME/.beef/beef
    exec ${beefGems}/bin/bundle exec ${ruby}/bin/ruby \$HOME/.beef/beef/beef "\$@"
  '';
in stdenv.mkDerivation {
  name = "beef";
  version = "2021-05-08";

  src = fetchFromGitHub {
    repo = "beef";
    owner = "beefproject";
    rev = "41403009065bd333a6c003e612b62e11ee0bffd8";
    sha256 = "5sh60PV9mAldMRe3bBHapIJv6EG7ipJNEGDuhGKDExk=";
  };

  patches = [
    ./db-homedir.patch
    ./move-media.patch
  ];

  buildInputs = [beefGems ruby];

  installPhase = ''
    mkdir -p $out/{bin,share/beef}
    cp -r * $out/share/beef
    sed -i "s;beef_cert.pem;$out/share/beef/beef_cert.pem;g"  $out/share/beef/config.yaml
    sed -i "s;beef_key.pem;$out/share/beef/beef_key.pem;g"  $out/share/beef/config.yaml
    cat > $out/bin/beef-xss <<EOF
${beefScript}
EOF
    chmod +x $out/bin/beef-xss
    ${lib.optionals includeGeoIPDatabase ''
      sed -i "s;/opt/GeoIP/GeoLite2-City.mmdb;${geoIPDatabase}/GeoLite2-City.mmdb;g"  $out/share/beef/config.yaml
    ''}
  '';
}
