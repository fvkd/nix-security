{ stdenv, lib, ant, fetchFromGitLab, jdk, jre, ... }:

let
  src = fetchFromGitLab {
    owner = "kalilinux/packages";
    repo = "armitage";
    rev = "e978339fc13bcd21356411587231fee7c035c2a4";
    sha256 = "YZGIrKJ9OCQyrOTPo5L8JqhdjPr1UsypajuMpgZHTOs=";
  };
in stdenv.mkDerivation {
  name = "armitage";

  inherit src;

  patches = [
    "${src}/debian/patches/fix-launch-script.patch"
    "${src}/debian/patches/fix-meterpreter.patch"
  ];

  buildInputs = [
    ant jdk
  ];

  buildPhase = ''
    sed -i 's/1\.6/1\.7/g' build.xml
    ant clean
    ant compile
    cp -r resources/ bin/
    cp -r scripts/ bin/
    rm -rf bin/*/*/.svn
    rm -rf bin/*/.svn
    ant jar
  '';

  installPhase = ''
    mkdir -p $out/{bin,share/armitage}

    cp debian/helper-script/* $out/bin/
    cp armitage.jar $out/share/armitage/
    cp cortana.jar $out/share/armitage/
    cp dist/unix/armitage $out/share/armitage/
    cp dist/unix/armitage-logo.png $out/share/armitage/
    cp dist/unix/teamserver $out/share/armitage/
    cp readme.txt $out/share/armitage/
    cp whatsnew.txt $out/share/armitage/

    sed -i "s;/usr;$out;g" $out/bin/*
    sed -i "s;java;${jre}/bin/java;g" $out/share/armitage/armitage $out/share/armitage/teamserver
  '';
}
