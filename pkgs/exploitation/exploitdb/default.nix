{ stdenv, lib, git, ncurses, utillinux, file, fetchFromGitLab, makeWrapper, cacert, ... }:

stdenv.mkDerivation {
  name = "exploitdb";

  version = "20210522";

  src = fetchFromGitLab {
    owner = "kalilinux/packages";
    repo = "exploitdb";
    rev = "1efe2e175bcddb8e4c58f2a199a146f166a9bb70";
    sha256 = "5CuL8gg6zYPB5f6LN5LrRRVJQmQtn1ZnWeboehnzAzA=";
  };

  buildInputs = [
    makeWrapper
  ];

  buildPhase = ''
    sed -i 's;/opt/exploitdb;$HOME/.exploitdb;g' .searchsploit_rc
    sed -i 's;sudo;$HOME/.exploitdb;g' searchsploit
  '';

  installPhase = ''
    mkdir -p $out/{bin,share/exploitdb}
    rm -rf debian
    cp -r searchsploit .searchsploit_rc $out/share/exploitdb/
    makeWrapper $out/share/exploitdb/searchsploit $out/bin/searchsploit --prefix PATH : ${lib.makeBinPath [ git file ]} --set GIT_SSL_NO_VERIFY true
  '';
}
