{ stdenv, lib, fetchFromGitHub, makeWrapper, msf, python3, fetchurl, python3Packages, callPackage, ...}:

let
  pymssql = callPackage ./pymssql.nix {
    inherit (python3Packages) buildPythonPackage fetchPypi cython setuptools-git setuptools-scm;
  };
in stdenv.mkDerivation {
  name = "set";
  version = "2021-01-07";
  src = fetchFromGitHub {
    owner = "trustedsec";
    repo = "social-engineer-toolkit";
    rev = "ef19c0ca85bc614fc8e420434fe5a58a518ca07e";
    sha256 = "SyOZLpSmApJYcEKk8m4tcfIGPBORvHcbrao2AKF+8ek=";
  };

  buildInputs = [ 
    makeWrapper
  ];

  patches = [
    (fetchurl {
      url = "https://github.com/trustedsec/social-engineer-toolkit/commit/cb326541c9a915862295f25aef6af7a0d747dce0.diff";
      sha256 = "pMYskto6BkuBCrN4zlvjXVwXgAx5rwsIz+QmAaWtITw=";
    })
  ];

  patchFlags = [ "-R" "-p1" ];

  installPhase = ''
    mkdir -p $out/{bin,share/set}
    sed -i 's;/usr/local/sbin/;;g' src/core/config.baseline
    sed -i 's;/usr/bin/;;g' src/core/config.baseline
    sed -i 's;/opt/metasploit/apps/pro/msf3;${msf}/share/msf;g' src/core/config.baseline
    sed -i 's;src/logs;/etc/setoolkit/logs;g' setoolkit
    sed -i 's;src/agreement4;/etc/setoolkit/agreement4;g' setoolkit
    sed -i 's;src/logs;/etc/setoolkit/logs;g' src/payloads/set_payloads/listener.py
    find . -name "*.py" -exec sed -i 's;src/html;/etc/setoolkit/html;g' {} \;
    cp -r * $out/share/set/
    rm $out/share/set/setup.py
    makeWrapper $out/share/set/setoolkit $out/bin/setoolkit --prefix PATH : ${lib.makeBinPath [ (python3.withPackages(p: with p; [ 
      pycrypto
      pymssql
      pexpect
      requests
      pyopenssl
      pefile
      impacket
      qrcode
      pillow
    ])) ]} --run "mkdir -p /etc/setoolkit/src/html && cp -r $out/share/set/src/html/* /etc/setoolkit/src/html/ && cd $out/share/set"
  '';
}
